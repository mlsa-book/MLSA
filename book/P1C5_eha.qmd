---
abstract: TODO (150-200 WORDS)
---

::: {.content-visible when-format="html"}
{{< include _macros.tex >}}
:::

# Event-history Analysis {#sec-eha}

{{< include _wip.qmd >}}

___


In this chapter we take a more general view on time-to-event data.
So far, we only considered a single potentially censored, outcome of interest.
Here we explore more complex settings with multiple, potentially mutually exclusive events and recurrences of events.
In this generalisation, data is sometimes refered to *event-history data* and its analysis as *event-history analysis* (EHA).

One way to think about event history data is in terms of transitions between different states, as illustrated in @fig-eha.
Usually, a subject starts out in state 0 (for example, 'healthy') and transitions to different states from there.
States from which further transitions are possible are called *transient*, otherwise a state is called *terminal*.

In the *single event* setting (@fig-eha, left panel), a subject can only transition to one state (the event of interest).
This setting was the focus of @sec-surv.
There, the censoring event was considered independent of the event of interest.

In the *competing risks* setting (@fig-eha, upper right panel, @sec-competing-risks), a subject could transition to any of the $K$ mutually exclusive states, thus the subject is initially *at risk* for a transition to multiple states.
However, once one of them occurs, it is impossible to transition to another (for example, death from different causes).
In both cases, the event needs not be terminal, we just end the observation after the first occurence of an event.

In the most general case, the *multi-state* setting (@fig-eha lower right panel, see @sec-multi-state), there are multiple transient and terminal states with potential back transitions (for example, moving between different stages of an illness with the possibility of (partial) recovery and death as terminal event).

In the *recurrent events setting* (@sec-recurrent-events), the same event can be observed multiple times on the same subject (for example reccurrent respiratory infections during one year).

![Illustration of different types of time-to-event processes. Upper-left: Standard single-event setting with transition from initial state (0) to state (1); Upper-right: Competing risks setting with $k$ competing events. Once one of the $\{1,\ldots, k\}$ events is observed, the others cannot be observed anymore;
Lower-left: Recurrent events setting with multiple occurences of the same event. Lower-right: Multi-state setting where subjects can transition between multiple transient with possible back-transitions or to terminal states.](Figures/survival/event-history-analysis.png){#fig-eha fig-alt="Schematic illustration of event history analysis."}


## Competing Risks {#sec-competing-risks}

In constrast to single-event survival analysis, competing risks are concerned with the time to the first of multiple, mutually exclusive events.
Mutually exclusive here means that once one of the events occurs, we can not observe the others (at the same time).
As in the single event case, the events may not necessarily be terminal (such as death), instead they just signify the end of the period of observation.
In contrast to the single event case, even if only one of the outcomes is of interest, the others can not be treated as independent censoring events.

@tbl-surv-data-sir.adm. shows an excerpt of the `sir.adm` data [@pkgmvna] of patients on the ICU.
Time under observation (`time`) could end in one of three outcomes: 0 (right-censoring at the end of the study), 1 (discharge alive), or 2 (death on ICU).
The interest was in how pneumonia status at admission to the ICU (`pneumonia`) affects mortality.

|    `id`| `time`| `status`| `pneumonia`|
|-------:|----:|------:|----:|
|   31561|    8|      0|    no|
|   31205|    8|      0|    no|
| 2002453|   31|      1|    yes|
| 1021616|    5|      1|    no|
| 1014059|    9|      2|    no|
| 1003059|    5|      2|    no|

: Subset of the `sir.adm` dataset [@pkgmvna].
Rows are individual observations (`id`), `time` is time under observation, `status` indicates the outcome observed (0=censored at the end of the study, 1=discharged alive from the ICU, 2: death in the ICU). {#tbl-surv-data-sir.adm}

Here, discharge from the hospital must not be considered independent right-censoring as was the case in the `tumor` data example in @sec-surv-km.
There, patients were followed even after hospital discharge, thus loss to follow-up could be considered truly random and therefore independent of the event of interest.
In this study on the other hand, follow-up stopped once patients were discharged and it is unrealistic to assume that subjects would continue to be exposed to the same risk of dying after discharge compared to subject still in the ICU.
Analysis of this data and how the different assumptions (independent censoring vs. competing risks) affects the estimates is given in @sec-aalen-johanson.

First, let's introduce the competing risks setting more formally. Let $Y$ be the time-to-event as before.
In the competing risks setting, there is now an additional random variable $E\in \{1,\ldots,q\}$ with realisations $e$, which denotes one of $q$ competing events that can occur at event time $Y$.
The survival outcome notation, $(Y, \Delta)$, thus has to be extended to accomodate for the possibility of competing risks.
Previously, we defined the status indicator $\Delta \in \{0,1\}$ for right-censored data.
In the competing risks setting we have $\Delta = I(Y_i \leq C_i) \wedge E_i = e$, such that
$\Delta \in \{0, 1, \ldots, q\}$ where $\Delta = 0$ indicates censoring as before (that is subject remained in state 0 until end of follow up) and $\Delta = e$ means the $e$th event occurred.
Rather then estimating the distribution of event times $P(Y\leq \tau)$, the goal is to estimate the joint distribution of $Y$ and $E$, $P(Y\leq \tau, E=e)$.

A common approach to competing-risks analysis is known as *cause-specific hazards*, where $h_{e}$ is defined as the hazard for the transition from initial state $0$ to state $e =1,\ldots,q$:
<!--  -->
$$
h_{e}(\tau) = \lim_{\triangle \tau \to 0} \frac{P(\tau \leq Y \leq \tau + \triangle \tau, E = e\ |\ Y \geq \tau)}{\triangle \tau}, \; e = 1, \dots, q.
$$ {#eq-cause-specific-hazard}
<!--  -->

Analogous to the singl-event case, we can also define the cause-specific cumulative hazard
<!--  -->
$$
H_{e}(\tau) = \int_{0}^\tau h_e(u)\ du
$$ {#eq-cause-specific-cumu-hazard}
<!--  -->

As competing events are mutually exclusive at any time $\tau$, it is possible to define the *all-cause hazard* which is the hazard of any event occuring as the sum of all cause-specific hazards
<!--  -->
$$
h(\tau) = \sum_{e = 1}^{q}h_{e}(\tau),
$$ {#eq-all-cause-hazard}
<!--  -->
as well as the *all-cause cumulative hazard*, which can be obtained either via the integral over the all-cause hazard (@eq-all-cause-hazard) or as sum of cause-specific cumulative  hazards (@eq-cause-specific-cumu-hazard):
<!--  -->
$$
H(\tau) = \int_{0}^\tau h(u)\ du = \sum_{e=1}^{q}\int_{0}^\tau h_{e}(u)\ du = \sum_{e=1}^q H_{e}(\tau).
$$ {#eq-all-cause-cumu-hazard}
<!--  -->
The *all-cause survival probability*
<!--  -->
$$
S(\tau) = P(Y > \tau) = \exp(-H(\tau))
$$ {#eq-all-cause-surv-prob}
<!--  -->
gives the probability that *none* of the events occurred before $\tau$.
It is usually not estimated directly but calculated from the cause specific hazards instead via @eq-all-cause-cumu-hazard and @eq-all-cause-surv-prob.

In applications, next to the cause-specific (cumulative) hazards, one is often interested in the *Cumulative Incidence Function* (CIF), which denotes the probability of experiencing an event $e$ before time $\tau$
<!--  -->
$$
F_{e}(\tau) = P(Y \leq \tau, E = e) = \int_{0}^\tau S(u-)h_{e}(u)\ \mathrm{d}u,\ e\in \{1,\ldots,q\},
$$ {#eq-cif}
<!--  -->
where

* $S(u-)$ is the probility of surviving (not experiencing any of the competing events) until the time-point shortly before $u$
* $S(u-)h_{e}(u)$ (@eq-continuous-hazard) is the probability of experiencing event $e$ at time point $u$.

$F_e(\tau)$ can be interpreted as the proportion of subjects who experienced event of type $e$ until time $\tau$.
Because the events are mutually exclusive, it holds that $F(\tau) = P(Y\leq\tau) = \sum_{e=1}^q F_e(\tau) = 1 - S(\tau)$.
As all terms of @eq-cif can be calculated from the cause-specific hazards (@eq-cause-specific-hazard), their estimation fully determines the joint distribution of $Y$ and $E$.




### Aalen-Johanson estimator {#sec-aalen-johanson}

As for the single-event case (@sec-surv-estimation-non-param), one can define a simple non-parametric estimator for the cause-specific cumulative hazard (@eq-cause-specific-cumu-hazard) based on a generalization of the Nelson-Aalen estimator (@eq-nelson-aalen) and the Aalen-Johanson estimator (@aalenEmpiricalTransitionMatrix1978) for the CIF (@eq-cif).

Recall from the definitions of the unique ordered event times $t_{(k)}, k=1\ldots,m$, risk-set at time $t_{(k)}$, $\calR_{t_{(k)}}$, number of events, $d_{t_{(k)}}$, and number at risk $n_{t_{(k)}}$ from @sec-data-rc.
Assume partitioning of the follow-up into $m$ disjunct intervals $(t_{(k-1)}, t_{(k)}],k=1,\ldots,m$, such that $Y\in (t_{(k-1)}, t_{(k)}] \Leftrightarrow \tilde{Y}=t_{(k)}$.

The *cause-specific* discrete time hazard (@eq-discrete-hazard) is defined by changing the numerator $d_{t_{(k)}}$ to $d_{e,t_{(k)}}$ (the number of events of type $e$ at time $t_{(k)}$)
<!--  -->
$$
h^d_{e}(t_{(k)}) := \frac{d_{e,t_{(k)}}}{n_{t_{(k)}}},\ e=\{1,\ldots,q\}.
$$ {#eq-cs-discrete-hazard}
<!--  -->
The Nelson-Aalen estimator (@eq-nelson-aalen) for the *cause-specific* cumulative hazard is then given by
<!--  -->
$$
H_{NA,e}(\tau) = \sum_{k:t_{(k)}\leq\tau} h^d_{e}(t_{(k)}) = \sum_{k:t_{(k)} \leq \tau} \frac{d_{e,t_{(k)}}}{n_{t_{(k)}}},
$$ {#eq-cs-nelson-aalen}
<!--  -->
wich yields a step function for each $e$, with jumps at timepoints $t_{(k)}$.


The all-cause survival probability follows from @eq-all-cause-cumu-hazard and @eq-all-cause-surv-prob as
<!--  -->
$$
S_{NA}(\tau) = \exp\left(-\sum_{e=1}^q H_{NA,e}(\tau)\right).
$$
<!--  -->
Finally, the Aalen-Johanson (AJ) estimator for the CIF follows via @eq-discrete-prob as
<!--  -->
$$
F_{AJ,e}(\tau) = \sum_{k:t_{(k)}\leq \tau} S_{NA}(\tau-)h^d_e(\tau)=  \sum_{k:t_{(k)}\leq \tau} S_{NA}(t_{(k-1)})\frac{d_{e,t_{(k)}}}{n_{t_{(k)}}}
$$ {#eq-aalen-johanson}
<!--  -->


For illustration of the AJ estimator and the interpretation of the CIFs consider the analysis conducted in @beyersmann.competing.2012, based on the data from @tbl-surv-data-sir.adm.
Recall that one is interested in estimation of the mortality conditional on pneumonia status at admission, while accounting for discharge from the ICU as competing risk ($E \in \{\text{"discharge"}, \text{"death"}\}$).
While the AJ estimator cannot naturally incorporate covariate information, it can be applied to subgroups of the data (here based on the pneumonia status).
Note that this will yield different sets of unique event times in each groups, thus the AJ can have jumps at different time-points for the two groups.

@fig-cif-sir shows the AJ estimates of the CIFs for each event (discharge/death) separately for patients with and without pneumonia. Examplary, the proportion of subjects with pneumonia being discharged until $\tau=120\text{ days}$ is approximately 75% ($\hat{F}_{\text{discharge}}(120) = P(Y\leq 120, E=\text{"discharge"})\approx 0.75$), while approximately 25% died in the ICU ($\hat{F}_{\text{death}}(120) = P(Y\leq 120, E=\text{"death"}))\approx 0.25$.
For patients without pneumonia we have $\hat{F}_{\text{discharge}}(120) \approx 0.91$ and $\hat{F}_{\text{death}} \approx 0.09$.
In this example, $\hat{F}_{\text{discharge}} + \hat{F}_{\text{death}} \approx 1$ for both pneumonia groups, as only 14 of 747 patients were censored (no discharge nor death) at the end of the follow-up.

![Aalen-Johanson estimator for the `sir.adm` data [@pkgmvna], stratified by pneumonia status at admission to the ICU. Left panel: Proportion of subjects discharged alive from the ICU. Right panel: Proportion of subjects who died in the ICU.](Figures/survival/cif-sir.png){#fig-cif-sir fig-alt="Illustration of the Aalen-Johanson estimator for the cumulative incidence function, stratified by pneumonia status at admission to the ICU."}



### Independent Censoring vs. Competing Risks {#sec-cens-vs-comp}

It is worth spending some time to consider the difference between independent right-censoring and competing risks.
Note that for the estimation of the hazard @eq-cs-discrete-hazard, occurences of competing events are implicitly assumed righ-censored (as $d_{e,t_{(k)}})$ only counts events of type $e$ and $n_{t_(k)}$ contains the same subjects that would remain if events of type $\tilde{e}\neq e$ were considered censored before $t_{(k)}$.
Nevertheless, competing risks are taken into account in the definition of the AJ estimator @eq-aalen-johanson, as the all-cause survival probability @eq-all-cause-surv-prob depends on all cause-specific hazards.

In contrast, assume that in our analysis of the `sir.adm` data we would consider time of discharge as independent right-censoring.
As we only have one other event (death), the data could be treated as single-event, right-censored data as in @sec-surv and therefore analysed using the Nelson-Aalen estimator (@eq-nelson-aalen, @eq-surv-na).
The probability of death before some time-point $\tau$ could thus be obtained via $P(Y\leq \tau) = F(\tau) = 1 - S_{NA}(\tau)$.


@fig-cens-vs-cr shows the estimates obtained under the two assumptions. Solid lines are indical to the right-hand side of @fig-cif-sir and indicate the probabilities under the competing risks assumption.
Dashed lines are obtained under the independent right-censoring assumption. Clearly, the probabilities of dying at time $\tau=120$ are overestimated when independent censoring is assumed.($\approx$ 75% vs. \approx 25% in the pneumonia group and $\approx$ 62% vs. \approx 13% in the no pneumonia group).


![Estimation of the probability of dying in the ICU conditional on pneumonia status at admission. Dashed lines give the probabilities under assumption of right-censoring. Solid lines give the probabilities when taking into account discharge as competing risk.](Figures/survival/cens-vs-cr.png){#fig-cens-vs-cr fig-alt=""}










## Multi-state Models {#sec-multi-state}

Multi-state models can be considered the most general type of survival data, as other types (single-event, competing risks, recurrent events) can be viewed as special cases.

A common multi-state model, the illness-death model, is illustrated in @fig-multi-state, left panel.
The states are 'healthy' (State 0), with illness (State 1), or death (State 2).
Healthy subjects can transition directly to death ($0\rightarrow 1$) or after previous illness ($0\rightarrow 1 \rightarrow 2$), without the possibility of back-transitions.
Similar to competing risks, individual transitions are characterised by transition-specific hazards, denoted by $h_{\ell\rightarrow e}(\tau)$ or short $h_{\ell e}(\tau)$, where $\ell$ is the starting state and $e$ the end state  for a transition, $\ell, e \in \{0,\ldots,q\}$.
Remaining in the same state (transition into the same sate $h_{\ell\ell}(\tau)$) is equivalent to being censored for any transition possible from that state.

![Left: The illness-death model where subjects can transition from states: healthy (0), with illness (1), and terminal state death (2) without back-transitions. Right: Illustration of a general multi-state model with back-transitions. Here subjects can transition from state healthy (0) to different disease progressions (1, 2) with (partial) recovery (0, 1) and terminal state death (3).](Figures/survival/multi-state-examples-w-transitions.png){#fig-multi-state fig-alt="Schematic illustration of different multi-state models."}

The right panel of @fig-multi-state depicts a more general multi-state setting with back-transitions.
One can think of transitions between a healthy state (0) to different disease progressions (1, 2) with possibilty of improvement and recovery, and possible transition to a terminal state (3).

When modeling such data, interest often lies in estimation of the transition hazards, but also in transition probabilities $P_{\ell e}(\zeta, \tau)$, that is the probability to transition from state $\ell$ to $e$ between time points $\zeta$ and $\tau$ or state occupation probabilities $P_e(\tau)$, the probability to occupy state $e$ at time $\tau$.
Transition probabilities are often summarized in a matrix of transtion probabilities $\mathbf{P}(\zeta, \tau)$, where rows indicate starting states and columns indicate end states.

For example, for the illness-death model, the transition matrix would be given as

$$\mathbf{P}(\zeta, \tau) :=
  \begin{pmatrix}
  P_{00}(\zeta, \tau) & P_{01}(\zeta, \tau) & P_{02}(\zeta, \tau)\\
  \bullet & P_{11}(\zeta, \tau) & P_{12}(\zeta, \tau)\\
  \bullet & \bullet & P_{22}(\zeta, \tau)\\
  \end{pmatrix}.
$$

$\bullet$ indicates impossible transitions, as in the illness-death model there are no transitions from higher to lower states.



## Recurrent Events {#sec-recurrent-events}

The *recurrent events* setting is defined by the same event type occurring multiple times.
While the recurrent events setting can be viewed as a special case of the multi-state setting (@sec-multi-state), we treat it here separately as it can also be approached as single event data with correlation.
Some examples of recurrent events include recurrence of infectious diseases, episodes of epilepsy, and replacements of machine parts.

@tbl-cgd-data shows data of chronic granolotomous disease (CGD) for two subjects.
Note the start-stop notation of the data ($t_{start}, t_{stop}$ respectively) that indicates the time in which a subject enters the risk set for the k*th* event number.
The column $\delta$ indicates whether the subject experienced the $k$th outbreak or was censored.
For example, Subject 1 (first three rows) experienced the first outbreak (first row) after 219 days, at which time they entered the risk set for event number 2.
The second event (second row) was experienced at 373 days and the subject was then censored for the third event (third row) after 414 days.
This notation is equivalent to a multi-state representation of the recurrent events process, where each event number represents a different state.
In @fig-recurrent-events, right panel, this is refered to as "Clock forward" approach.

| ID| $k$ | $t_{start}$| $t_{stop}$|$\delta$|$gap$|
|--:|---:|---:|------:|--:|-----:|
|  1|1|  0 | 219|   1| 219| 
|  1|2|219 | 373|   1| 154| 
|  1|3|373 | 414|   0|  41| 
|  7|1|  0 | 292|   1| 292| 
|  7|2|292 | 364|   0|  72| 
: Subset of the `cgd`  [@pkgsurvival] time-to-event dataset.
Rows are individual observation units ($ID$), $k$ is the $k$th event occurrence, $t_{start}$ and $t_{stop}$ mark the beginning and end of the "at risk time" for the $k$th event occurence, $\delta$ is the event indicator and $gap = t_{stop} - t_{start}$. {#tbl-cgd-data}

For recurrent events data without competing (terminal) events, the "Clock reset" approach (@fig-recurrent-events, left panel) can be used.
Instead of representing the data in the start-stop notation, the gap time is calculated instead (see fourth column in @tbl-cgd-data).
In this representation, we only consider how long the subject was at risk for the $k$th event, not at which time (on the calendar time scale).
It has the advantage that standard methods for analysis of single-event data can be used for modeling.
However, the resulting dependency between multiple data points from one subject (at risk for multiple events at the same time) needs to be taken into account in the modeling step.

![Illustration of transitions in the recurrent events setting. Left: "Clock reset" representation of recurrent events. Each time an event occurs, the clock is reset to 0 and we once again wait for occurence of an event (of the same type); Right: "Clock forward" representation. A subject transitions from 1st, to 2nd, etc. to $K$th event occurence](Figures/survival/recurrent-events.png){#fig-recurrent-events fig-alt="Schematic illustration of recurrent events transitions."}

The distribution of event recurrences per subject is often right-skewed in real data sets, which implies that there are only few events past event number $e^*$.
In practice, therefore, the data is often summarized such that we have event numbers $e = 1,\ldots, e^*_+$, where $e^*_+$ represents category "$e^*$ or higher".